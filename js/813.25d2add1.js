"use strict";(self["webpackChunksanyue_imghub"]=self["webpackChunksanyue_imghub"]||[]).push([[813],{2813:function(e,t,i){i.r(t),i.d(t,{default:function(){return w}});var n=i(6768),s=i(4232);const o={class:"root"},a={class:"waterfall-container",ref:"container"},h={class:"waterfall-grid"},r=["src","alt","onLoad"],l={key:0,class:"loading-text"};function c(e,t,i,c,d,u){return(0,n.uX)(),(0,n.CE)("div",o,[(0,n.Lk)("div",a,[(0,n.Lk)("div",h,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(d.images,((e,t)=>((0,n.uX)(),(0,n.CE)("div",{key:t,class:(0,s.C4)(["image-item",{loading:!e.loaded}]),style:(0,s.Tr)({left:e.column*d.columnWidth+"px",top:`${e.top}px`,width:`${d.columnWidth}px`,height:`${e.height}px`})},[(0,n.Lk)("img",{src:e.url,alt:"Image "+t,loading:"lazy",onLoad:t=>u.handleImageLoad(e),class:(0,s.C4)({loaded:e.loaded})},null,42,r)],6)))),128))]),d.loading?((0,n.uX)(),(0,n.CE)("p",l,"加载中...")):(0,n.Q3)("",!0)],512)])}i(4114);var d=i(782),u={data(){return{images:[],minWidth:100,columnCount:3,columnWidth:0,columns:[],loading:!1,observer:null,resizeTimeout:null,imageSizeCache:[]}},mounted(){this.$nextTick((()=>{this.updateColumnCount(),window.addEventListener("resize",this.onResize),window.addEventListener("scroll",this.onScroll)})),this.loadImages(),this.initObserver()},computed:{...(0,d.L8)(["credentials","adminUrlSettings","userConfig"])},beforeDestroy(){window.removeEventListener("scroll",this.onScroll),window.removeEventListener("resize",this.onResize),this.observer?.disconnect()},methods:{onResize(){clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout((()=>{this.updateColumnCount()}),300)},initObserver(){this.observer||(this.observer=new IntersectionObserver((e=>{e[0]?.isIntersecting&&this.loadImages()}),{threshold:.5}),this.observeSecondLastRow())},updateColumnCount(){if(!this.$refs?.container)return;const e=this.$refs.container.clientWidth;this.columnCount=Math.max(1,Math.floor(e/this.minWidth)),this.columnWidth=e/this.columnCount,this.columns=new Array(this.columnCount).fill(0),this.reflowImages()},async reflowImages(){if(!this.images.length)return;const e=new Array(this.columnCount).fill(0),t=this.images.map((t=>{const i=this.getMinColumnIndex(e);return t.column=i,t.top=e[i],e[i]+=t.height,t}));this.columns=e,this.images=t,this.checkFull()},checkFull(){this.$nextTick((()=>{const e=this.$refs.container.scrollHeight,t=window.innerHeight;e<t&&(console.log("内容不足，继续加载图片"),this.loadImages())}))},getMinColumnIndex(e){return e.indexOf(Math.min(...e))},observeSecondLastRow(){this.$nextTick((()=>{const e=this.getSecondLastRowImage();e&&(this.observer?.disconnect(),this.observer.observe(e))}))},getSecondLastRowImage(){const e=this.$el.querySelectorAll(".image-item"),t=this.columnCount,i=Math.max(0,e.length-2*t),n=Array.from(e).slice(i,i+t);return n[n.length-1]||null},async loadImages(){if(!this.loading){this.loading=!0,0===this.columnWidth&&this.updateColumnCount();try{const e=await this.fetchWithAuth("/api/manage/check",{method:"GET"}),t=await e.text();if("true"!==t&&"Not using basic auth."!==t)throw new Error("Unauthorized");const i=await this.fetchWithAuth(`/api/manage/list?start=${this.images.length}&count=20&random=true`,{method:"GET"}).then((e=>e.json()));this.imageSizeCache=this.imageSizeCache||{};for(const n of i){const e="/file/"+n.name;this.loadSingleImage(n,e)}}catch(e){console.error(e),"Unauthorized"!==e.message&&this.$message.error("同步数据时出错，请检查网络连接")}finally{this.loading=!1,this.observeSecondLastRow()}}},async loadSingleImage(e,t){let i;try{if(e.height&&e.width)i=this.columnWidth*(e.height/e.width);else{this.imageSizeCache[t]||(this.imageSizeCache[t]=this.loadImageSize(t));const{width:e,height:n}=await this.imageSizeCache[t];i=this.columnWidth*(n/e)}const n=this.getMinColumnIndex(this.columns),s=this.columns[n];this.columns[n]+=i;const o={url:t,height:i,top:s,column:n,loaded:!1,channelTag:this.getChannelTag(e.metadata?.Channel)};this.images.push(o)}catch(n){console.warn("加载单图失败:",t,n)}},getChannelTag(e){return"TelegramNew"===e?"TG":"CloudflareR2"===e?"R2":"S3"===e?"S3":"未知"},updateImageHeight(e,t){this.$nextTick((()=>{const i=this.$el.querySelectorAll(".image-item img")[t];i&&(e.height=i.clientHeight,this.reflowPending||(this.reflowPending=!0,requestAnimationFrame((()=>{this.reflowImages(),this.reflowPending=!1}))))}))},loadImageSize(e){return new Promise(((t,i)=>{const n=new Image;n.onload=()=>t({width:n.width,height:n.height}),n.onerror=i,n.src=e}))},onScroll(){const e=window.scrollY+window.innerHeight,t=this.$refs.container.scrollHeight;t-e<200&&!this.loading&&(console.log("快到底部了，自动加载更多图片"),this.loadImages())},async fetchWithAuth(e,t={}){this.credentials&&(t.headers={...t.headers,Authorization:`Basic ${this.credentials}`},t.credentials="include");const i=await fetch(e,t);if(401===i.status)throw this.$message.error("认证状态错误，请重新登录"),this.$router.push("/adminLogin"),new Error("Unauthorized");return i},handleImageLoad(e){e.loaded=!0}}},m=i(1241);const g=(0,m.A)(u,[["render",c],["__scopeId","data-v-68e381be"]]);var w=g}}]);
//# sourceMappingURL=813.25d2add1.js.map