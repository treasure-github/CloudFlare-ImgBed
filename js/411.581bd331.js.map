{"version":3,"file":"js/411.581bd331.js","mappings":"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","sources":["webpack://sanyue_imghub/./src/views/fallImg.vue?3c98","webpack://sanyue_imghub/./src/views/fallImg.vue","webpack://sanyue_imghub/./src/views/fallImg.vue?55c6"],"sourcesContent":["import { renderList as _renderList, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock, normalizeClass as _normalizeClass, createElementVNode as _createElementVNode, normalizeStyle as _normalizeStyle, createCommentVNode as _createCommentVNode } from \"vue\";\nconst _hoisted_1 = {\n  class: \"root\"\n};\nconst _hoisted_2 = {\n  class: \"waterfall-container\",\n  ref: \"container\"\n};\nconst _hoisted_3 = {\n  class: \"waterfall-grid\"\n};\nconst _hoisted_4 = [\"src\", \"alt\", \"onLoad\"];\nconst _hoisted_5 = {\n  key: 0,\n  class: \"loading-text\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createElementVNode(\"div\", _hoisted_2, [_createElementVNode(\"div\", _hoisted_3, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($data.images, (image, index) => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: index,\n      class: _normalizeClass([\"image-item\", {\n        loading: !image.loaded\n      }]),\n      style: _normalizeStyle({\n        left: `${image.column * $data.columnWidth}px`,\n        top: `${image.top}px`,\n        width: `${$data.columnWidth}px`,\n        height: `${image.height}px`\n      })\n    }, [_createElementVNode(\"img\", {\n      src: image.url,\n      alt: 'Image ' + index,\n      loading: \"lazy\",\n      onLoad: $event => $options.handleImageLoad(image),\n      class: _normalizeClass({\n        loaded: image.loaded\n      })\n    }, null, 42, _hoisted_4)], 6);\n  }), 128))]), $data.loading ? (_openBlock(), _createElementBlock(\"p\", _hoisted_5, \"加载中...\")) : _createCommentVNode(\"\", true)], 512)]);\n}","import \"core-js/modules/es.array.push.js\";\nimport { mapGetters } from 'vuex';\nexport default {\n  data() {\n    return {\n      images: [],\n      minWidth: 100,\n      columnCount: 3,\n      columnWidth: 0,\n      columns: [],\n      // 存放每列当前累积的高度\n      loading: false,\n      observer: null,\n      resizeTimeout: null,\n      imageSizeCache: []\n    };\n  },\n  mounted() {\n    this.$nextTick(() => {\n      this.updateColumnCount();\n      window.addEventListener(\"resize\", this.onResize);\n      window.addEventListener(\"scroll\", this.onScroll);\n    });\n    this.loadImages();\n    this.initObserver();\n  },\n  computed: {\n    ...mapGetters(['credentials', 'adminUrlSettings', 'userConfig'])\n  },\n  beforeDestroy() {\n    window.removeEventListener(\"scroll\", this.onScroll);\n    window.removeEventListener(\"resize\", this.onResize);\n    this.observer?.disconnect();\n  },\n  methods: {\n    // 监听窗口大小变化\n    onResize() {\n      clearTimeout(this.resizeTimeout);\n      this.resizeTimeout = setTimeout(() => {\n        this.updateColumnCount();\n      }, 300); // 延迟 300ms 避免频繁触发\n    },\n    // 初始化 IntersectionObserver 监听滚动\n    initObserver() {\n      if (!this.observer) {\n        this.observer = new IntersectionObserver(entries => {\n          if (entries[0]?.isIntersecting) {\n            this.loadImages();\n          }\n        }, {\n          threshold: 0.5\n        });\n        this.observeSecondLastRow();\n      }\n    },\n    // 计算列数，并重新布局\n    updateColumnCount() {\n      if (!this.$refs?.container) return;\n      const containerWidth = this.$refs.container.clientWidth;\n      const screenWidth = window.innerWidth;\n\n      // 根据屏幕宽度设置 minWidth，适配手机、平板、PC\n      let minWidth;\n      if (screenWidth >= 1024) {\n        minWidth = 250; // PC\n      } else if (screenWidth >= 768) {\n        minWidth = 180; // 平板\n      } else {\n        minWidth = 120; // 手机\n      }\n      this.minWidth = minWidth;\n\n      // 计算列数，至少 1 列\n      this.columnCount = Math.max(1, Math.floor(containerWidth / minWidth));\n      // 根据列数计算列宽，铺满容器宽度\n      this.columnWidth = containerWidth / this.columnCount;\n\n      // 重置每列高度\n      this.columns = new Array(this.columnCount).fill(0);\n\n      // 重新布局图片\n      this.reflowImages();\n    },\n    // 重新布局图片\n    async reflowImages() {\n      if (!this.images.length) return;\n\n      // 更新列数\n      const newColumns = new Array(this.columnCount).fill(0);\n\n      // 更新每张图片的位置\n      const updatedImages = this.images.map(image => {\n        const minCol = this.getMinColumnIndex(newColumns);\n        image.column = minCol;\n        image.top = newColumns[minCol];\n        newColumns[minCol] += image.height;\n        return image;\n      });\n      this.columns = newColumns;\n      this.images = updatedImages;\n      this.checkFull();\n    },\n    checkFull() {\n      // 等 DOM 更新完成再判断是否填满页面\n      this.$nextTick(() => {\n        const containerHeight = this.$refs.container.scrollHeight;\n        const viewportHeight = window.innerHeight;\n        if (containerHeight < viewportHeight) {\n          console.log('内容不足，继续加载图片');\n          this.loadImages(); // 继续加载直到填满\n        }\n      });\n    },\n    // 获取最矮列的索引\n    getMinColumnIndex(columns) {\n      return columns.indexOf(Math.min(...columns));\n    },\n    observeSecondLastRow() {\n      this.$nextTick(() => {\n        const target = this.getSecondLastRowImage();\n        if (target) {\n          this.observer?.disconnect(); // 防止重复监听\n          this.observer.observe(target);\n        }\n      });\n    },\n    getSecondLastRowImage() {\n      const imageItems = this.$el.querySelectorAll(\".image-item\");\n      const imagesPerRow = this.columnCount;\n      const startIndex = Math.max(0, imageItems.length - imagesPerRow * 2);\n      const lastSecondRowImages = Array.from(imageItems).slice(startIndex, startIndex + imagesPerRow);\n      return lastSecondRowImages[lastSecondRowImages.length - 1] || null;\n    },\n    // 加载图片\n    async loadImages() {\n      if (this.loading) return;\n      this.loading = true;\n      if (this.columnWidth === 0) {\n        this.updateColumnCount();\n      }\n      try {\n        const response = await this.fetchWithAuth(\"/api/manage/check\", {\n          method: 'GET'\n        });\n        const result = await response.text();\n        if (result !== \"true\" && result !== \"Not using basic auth.\") {\n          throw new Error(\"Unauthorized\");\n        }\n        const imgList = await this.fetchWithAuth(`/api/manage/list?start=${this.images.length}&count=20&random=true`, {\n          method: \"GET\"\n        }).then(res => res.json());\n        this.imageSizeCache = this.imageSizeCache || {};\n\n        // 不等待统一完成，逐张加载、处理并推入\n        for (const e of imgList) {\n          const url = \"/file/\" + e.name;\n\n          // 开始异步处理每张图片\n          this.loadSingleImage(e, url);\n        }\n      } catch (err) {\n        console.error(err);\n        if (err.message !== \"Unauthorized\") {\n          this.$message.error(\"同步数据时出错，请检查网络连接\");\n        }\n      } finally {\n        this.loading = false;\n        this.observeSecondLastRow();\n      }\n    },\n    async loadSingleImage(e, url) {\n      let height;\n      try {\n        if (e.height && e.width) {\n          height = this.columnWidth * (e.height / e.width);\n        } else {\n          if (!this.imageSizeCache[url]) {\n            this.imageSizeCache[url] = this.loadImageSize(url);\n          }\n          const {\n            width,\n            height: realHeight\n          } = await this.imageSizeCache[url];\n          height = this.columnWidth * (realHeight / width);\n        }\n        const col = this.getMinColumnIndex(this.columns);\n        const top = this.columns[col];\n        this.columns[col] += height;\n        const image = {\n          url,\n          height,\n          top,\n          column: col,\n          loaded: false,\n          channelTag: this.getChannelTag(e.metadata?.Channel)\n        };\n        this.images.push(image);\n        await this.reflowImages(); // 布局重新计算\n      } catch (err) {\n        console.warn(\"加载单图失败:\", url, err);\n      }\n    },\n    getChannelTag(channel) {\n      if (channel === 'TelegramNew') return 'TG';\n      if (channel === 'CloudflareR2') return 'R2';\n      if (channel === 'S3') return 'S3';\n      return '未知';\n    },\n    // 更新图片高度\n    updateImageHeight(image, index) {\n      this.$nextTick(() => {\n        const imgElement = this.$el.querySelectorAll(\".image-item img\")[index];\n        if (imgElement) {\n          image.height = imgElement.clientHeight;\n          if (!this.reflowPending) {\n            this.reflowPending = true;\n            requestAnimationFrame(() => {\n              this.reflowImages();\n              this.reflowPending = false;\n            });\n          }\n        }\n      });\n    },\n    loadImageSize(url) {\n      return new Promise((resolve, reject) => {\n        const img = new Image();\n        img.onload = () => resolve({\n          width: img.width,\n          height: img.height\n        });\n        img.onerror = reject;\n        img.src = url;\n      });\n    },\n    onScroll() {\n      const scrollBottom = window.scrollY + window.innerHeight;\n      const containerBottom = this.$refs.container.scrollHeight;\n      if (containerBottom - scrollBottom < 200 && !this.loading) {\n        console.log('快到底部了，自动加载更多图片');\n        this.loadImages();\n      }\n    },\n    async fetchWithAuth(url, options = {}) {\n      if (this.credentials) {\n        options.headers = {\n          ...options.headers,\n          'Authorization': `Basic ${this.credentials}`\n        };\n        options.credentials = 'include';\n      }\n      const response = await fetch(url, options);\n      if (response.status === 401) {\n        this.$message.error('认证状态错误，请重新登录');\n        this.$router.push('/adminLogin');\n        throw new Error('Unauthorized');\n      }\n      return response;\n    },\n    handleImageLoad(image) {\n      image.loaded = true; // 确保 Vue 能追踪到属性变更\n    }\n  }\n};","/* unplugin-vue-components disabled */import { render } from \"./fallImg.vue?vue&type=template&id=c526b8da&scoped=true\"\nimport script from \"./fallImg.vue?vue&type=script&lang=js\"\nexport * from \"./fallImg.vue?vue&type=script&lang=js\"\n\nimport \"./fallImg.vue?vue&type=style&index=0&id=c526b8da&scoped=true&lang=css\"\n\nimport exportComponent from \"../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render],['__scopeId',\"data-v-c526b8da\"]])\n\nexport default __exports__"],"names":["_hoisted_1","class","_hoisted_2","ref","_hoisted_3","_hoisted_4","_hoisted_5","key","render","_ctx","_cache","$props","$setup","$data","$options","images","image","index","loading","loaded","style","left","column","columnWidth","top","width","height","src","url","alt","onLoad","$event","handleImageLoad","data","minWidth","columnCount","columns","observer","resizeTimeout","imageSizeCache","mounted","this","$nextTick","updateColumnCount","window","addEventListener","onResize","onScroll","loadImages","initObserver","computed","beforeDestroy","removeEventListener","disconnect","methods","clearTimeout","setTimeout","IntersectionObserver","entries","isIntersecting","threshold","observeSecondLastRow","$refs","container","containerWidth","clientWidth","screenWidth","innerWidth","Math","max","floor","Array","fill","reflowImages","length","newColumns","updatedImages","map","minCol","getMinColumnIndex","checkFull","containerHeight","scrollHeight","viewportHeight","innerHeight","console","log","indexOf","min","target","getSecondLastRowImage","observe","imageItems","$el","querySelectorAll","imagesPerRow","startIndex","lastSecondRowImages","from","slice","response","fetchWithAuth","method","result","text","Error","imgList","then","res","json","e","name","loadSingleImage","err","error","message","$message","loadImageSize","realHeight","col","channelTag","getChannelTag","metadata","Channel","push","warn","channel","updateImageHeight","imgElement","clientHeight","reflowPending","requestAnimationFrame","Promise","resolve","reject","img","Image","onload","onerror","scrollBottom","scrollY","containerBottom","options","credentials","headers","fetch","status","$router","__exports__"],"sourceRoot":""}